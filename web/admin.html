<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Textos y Logo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
    body {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        min-height: 100vh;
    }
    .card {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 4px 24px 0 #0001;
        border: none;
    }
    .form-label, .form-control, .form-select {
        transition: box-shadow 0.3s, text-shadow 0.3s, color 0.3s;
    }
    .form-label i {
        transition: color 0.3s;
        color: #495057;
    }
    .form-label:hover i, .form-label:focus i {
        color: #0d6efd;
    }
    .form-label:hover, .form-label:focus {
        text-shadow: 0 2px 8px #0d6efd33, 0 0 2px #0d6efd;
        color: #0d6efd;
    }
    .form-control:focus, .form-control:hover, .form-select:focus, .form-select:hover {
        box-shadow: 0 0 0 0.2rem #0d6efd33, 0 2px 8px #0d6efd33;
        border-color: #0d6efd;
    }
    .btn-modern {
        background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
        color: #fff;
        border: none;
        border-radius: 2rem;
        font-weight: 600;
        box-shadow: 0 2px 12px 0 #1976d233;
        transition: box-shadow 0.2s, background 0.2s, transform 0.2s;
        letter-spacing: 0.5px;
    }
    .btn-modern:hover, .btn-modern:focus {
        background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
        box-shadow: 0 4px 24px 0 #1976d266;
        color: #fff;
        transform: translateY(-2px) scale(1.03);
    }
    /* Animación para el icono de papelera */
    @keyframes shake-trash {
      10% { transform: scale(1.2) rotate(-10deg); }
      20% { transform: scale(1.1) rotate(10deg); }
      30% { transform: scale(1.2) rotate(-10deg); }
      40% { transform: scale(1.1) rotate(10deg); }
      50% { transform: scale(1.2) rotate(-10deg); }
      60% { transform: scale(1.1) rotate(10deg); }
      70% { transform: scale(1.2) rotate(-10deg); }
      80% { transform: scale(1.1) rotate(10deg); }
      90% { transform: scale(1.2) rotate(-10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    </style>
</head>
<body>
    <div class="container py-4">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
          <div class="card p-4 mb-4 mt-2">
            <h1 class="mb-4 text-center">Administrar Textos y Logo</h1>
            <form id="textosForm">
              <div class="row g-3">
                <div class="col-md-6 form-group">
                  <label for="clave" class="form-label"><i class="bi bi-key-fill me-2" style="color:#ffb300;"></i>Clave</label>
                  <input type="text" class="form-control" id="clave" name="clave" required>
                </div>
                <div class="col-md-6 form-group">
                  <label for="valor" class="form-label"><i class="bi bi-pencil-square me-2" style="color:#3949ab;"></i>Valor</label>
                  <input type="text" class="form-control" id="valor" name="valor" required />
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button type="submit" class="btn btn-modern btn-lg px-5 py-2"><i class="bi bi-save2-fill me-2"></i>Guardar Texto</button>
                </div>
              </div>
            </form>
            <hr>
            <h2 class="mb-3 text-center">Textos guardados</h2>
            <div class="table-responsive mb-4">
              <table class="table table-striped align-middle" id="tablaTextos">
                <thead>
                  <tr>
                    <th style="width: 25%">Clave</th>
                    <th>Valor</th>
                    <th style="width: 100px">Acción</th>
                  </tr>
                </thead>
                <tbody id="listaTextos"></tbody>
              </table>
            </div>
            <form id="logoForm" enctype="multipart/form-data">
              <div class="row g-3 align-items-end">
                <div class="col-md-8 form-group">
                  <label for="logo" class="form-label"><i class="bi bi-image-fill me-2" style="color:#43a047;"></i>Logo</label>
                  <input class="form-control" type="file" id="logo" name="logo" accept="image/*" required>
                  <div class="mt-2">
                    <img id="logoPreview" src="" alt="Vista previa logo" style="max-width:60px;max-height:60px;display:none;border-radius:8px;border:1px solid #ccc;" />
                  </div>
                </div>
                <div class="col-md-4 d-flex align-items-center">
                  <button type="submit" class="btn btn-modern btn-lg w-100 py-2"><i class="bi bi-arrow-repeat me-2"></i>Actualizar Logo</button>
                </div>
              </div>
            </form>
            <div id="result" class="mt-4"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal fade" id="modalConfirm" tabindex="-1" aria-labelledby="modalConfirmLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalConfirmLabel">Confirmar acción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p id="modalConfirmMsg" class="mb-0"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="btnModalConfirmar">Eliminar</button>
          </div>
        </div>
      </div>
    </div>

<script>
async function cargarTextos() {
    const res = await fetch('/api/textos');
    const textos = await res.json();
    const lista = document.getElementById('listaTextos');
    lista.innerHTML = '';
    Object.entries(textos).forEach(([clave, valor]) => {
        const tr = document.createElement('tr');
        // Clave (clickeable)
        const tdClave = document.createElement('td');
        tdClave.style.cursor = 'pointer';
        tdClave.title = 'Editar este texto';
        tdClave.innerText = clave;
        tdClave.onclick = function() {
          document.getElementById('clave').value = clave;
          document.getElementById('valor').value = valor;
        };
        tr.appendChild(tdClave);
        // Valor (clickeable)
        const tdValor = document.createElement('td');
        tdValor.style.cursor = 'pointer';
        tdValor.title = 'Editar este texto';
        tdValor.innerText = valor;
        tdValor.onclick = function() {
          document.getElementById('clave').value = clave;
          document.getElementById('valor').value = valor;
        };
        tr.appendChild(tdValor);
        // Acción
        const tdAccion = document.createElement('td');
        const icon = document.createElement('i');
        icon.className = 'bi bi-trash-fill';
        icon.style.cursor = 'pointer';
        icon.style.fontSize = '1.3rem';
        icon.style.color = '#e53935';
        icon.title = 'Eliminar';
        icon.onmouseenter = function() {
          icon.style.color = '#b71c1c';
          icon.style.transform = 'scale(1.2) rotate(-10deg)';
          icon.style.transition = 'all 0.2s';
        };
        icon.onmouseleave = function() {
          icon.style.color = '#e53935';
          icon.style.transform = 'scale(1) rotate(0deg)';
        };
        icon.onclick = async function() {
          icon.style.animation = 'shake-trash 0.4s';
          await eliminarTexto(clave);
          setTimeout(() => { icon.style.animation = ''; }, 400);
        };
        tdAccion.appendChild(icon);
        tr.appendChild(tdAccion);
        lista.appendChild(tr);
    });
}

// Mostrar alert bonito con fade y cierre automático
function mostrarAlerta(mensaje, tipo) {
  const result = document.getElementById('result');
  result.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert" style="font-size:1.1rem;">
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>`;
  setTimeout(() => {
    const alert = result.querySelector('.alert');
    if (alert) {
      alert.classList.remove('show');
      alert.classList.add('fade');
      setTimeout(() => { if (alert.parentNode) alert.parentNode.removeChild(alert); }, 500);
    }
  }, 2500);
}

// Modal de confirmación Bootstrap
function mostrarConfirmacion(mensaje) {
  return new Promise((resolve) => {
    let modal = document.getElementById('modalConfirm');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modalConfirm';
      modal.className = 'modal fade';
      modal.tabIndex = -1;
      modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class='bi bi-question-circle-fill me-2 text-warning'></i>Confirmar acción</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <p id="modalConfirmMsg" class="mb-0"></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-danger" id="btnModalConfirmar"><i class="bi bi-trash me-1"></i>Eliminar</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modal);
    }
    document.getElementById('modalConfirmMsg').textContent = mensaje;
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    const btn = document.getElementById('btnModalConfirmar');
    btn.onclick = () => {
      modalInstance.hide();
      resolve(true);
    };
    modal.querySelector('.btn-secondary').onclick = () => {
      modalInstance.hide();
      resolve(false);
    };
    modal.addEventListener('hidden.bs.modal', () => resolve(false), { once: true });
  });
}

async function eliminarTexto(clave) {
    const ok = await mostrarConfirmacion('¿Seguro que deseas eliminar este texto?');
    if (!ok) return;
    const res = await fetch('/api/texto/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({clave})
    });
    if (res.ok) {
        cargarTextos();
        mostrarAlerta('Texto eliminado correctamente.', 'success');
    } else {
        mostrarAlerta('Error al eliminar texto.', 'danger');
    }
}
async function guardarTextoAuto() {
    const clave = document.getElementById('clave').value;
    const valor = document.getElementById('valor').value;
    if (!clave || !valor) return;
    const res = await fetch('/api/texto', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({clave, valor})
    });
    if (res.ok) {
        document.getElementById('result').innerHTML = '<div class="alert alert-success">Texto guardado automáticamente.</div>';
        cargarTextos();
    } else {
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Error al guardar texto.</div>';
    }
}
const oldSubmit = document.getElementById('textosForm').onsubmit;
document.getElementById('textosForm').onsubmit = async function(e) {
    e.preventDefault();
    const clave = document.getElementById('clave').value;
    const valor = document.getElementById('valor').value;
    if (!clave || !valor) return;
    const res = await fetch('/api/texto', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({clave, valor})
    });
    if (res.ok) {
        mostrarAlerta('Texto guardado.', 'success');
        cargarTextos();
        // Limpiar los campos del formulario
        document.getElementById('clave').value = '';
        document.getElementById('valor').value = '';
    } else {
        mostrarAlerta('Error al guardar texto.', 'danger');
    }
}
window.onload = function() {
  cargarTextos();
  // Mostrar logo actual guardado
  fetch('/api/logo')
    .then(res => res.json())
    .then(data => {
      if (data && data.url) {
        const logoPreview = document.getElementById('logoPreview');
        if (logoPreview) {
          logoPreview.src = data.url;
          logoPreview.style.display = 'block';
        }
      }
    });
};
const oldLogo = document.getElementById('logoForm').onsubmit;
document.getElementById('logoForm').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/api/logo', {
        method: 'POST',
        body: formData
    });
    if (res.ok) {
        mostrarAlerta('Logo actualizado.', 'success');
    } else {
        mostrarAlerta('Error al actualizar logo.', 'danger');
    }
}
// Validar tamaño y dimensiones del logo antes de enviar y subirlo vía AJAX
document.getElementById('logo').addEventListener('change', function(e) {
  const file = this.files[0];
  if (!file) return;
  if (file.size > 1024 * 1024) {
    alert('El logo no debe superar los 1MB.');
    this.value = '';
    return;
  }
  const img = new Image();
  img.onload = () => {
    if (img.width > 1900 || img.height > 1900) {
      alert('El logo no debe superar 1900x1900 píxeles.');
      document.getElementById('logo').value = '';
      return;
    }
    // Vista previa del logo
    const logoPreview = document.getElementById('logoPreview');
    if (logoPreview) {
      logoPreview.src = URL.createObjectURL(file);
      logoPreview.style.display = 'block';
    }
  }
  img.src = URL.createObjectURL(file);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
